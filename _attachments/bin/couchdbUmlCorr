#! /bin/bash
# Rolf Niepraschk, Rolf.Niepraschk@ptb.de, 2012/07/06

SERVER0="localhost" # Quelle (couchDB 1.1)
SERVER1="localhost" # Ziel

PORT="5984"

DB0="vaclab_db"  # Quelle
DB1="vaclab_db_" # Ziel

##ID_LIST="_design/helper/_list/get_id_csv/all_ids"
###ID_LIST="_design/helper/_list/get_id_csv/selected_ids"

# sed-genehme Definitionen der falschen Zeichen:

#   1. von couchDB 1.2 gesendet (vorerst nicht benutzt):

# ???

# aUml='\xc3[^\xa4]*\xa4'
# oUml='\xc3[^\xb6]*\xb6'
# uUml='\xc3[^\xbc]*\xbc'
#   sz='\xc3[^\x9f]*\x9f'

# ^^^^^^^ Funktioniert so nicht!

#   2. von couchDB 1.1 gesendet:

aUml='\\u00c3[^a]*[^4]*\\u00a4'
oUml='\\u00c3[^b]*[^6]*\\u00b6'
uUml='\\u00c3[^b]*[^c]*\\u00bc'
  sz='\\u00c3[^9]*[^f]*\\u009f'
AUml='\\u00c3[^8]*[^4]*\\u0084'
OUml='\\u00c3[^9]*[^6]*\\u0096'
UUml='\\u00c3[^9]*[^c]*\\u009c'

# Spezialfall: Verhunzter Bis-Strich (ndash) in Literaturangabe zwischen den
# Seitenzahlen 938 und 944.

pagesNdash='\(Pages 938\)[^9]*[^4]*\(944\)'

IDs=$(curl http://$SERVER0:$PORT/$DB0/$ID_LIST 2>/dev/null)
IDs=( "5c9f2659545fe56374723402d2038d50" )
idx=0

for id in $IDs; do
  idx=$(($idx+1))
  echo $idx=$id
  doc0=$(curl http://$SERVER0:$PORT/$DB0/$id 2>/dev/null)
  doc1=`echo $doc0 | sed \
        -e "s/$aUml/ä/g" \
        -e "s/$oUml/ö/g" \
        -e "s/$uUml/ü/g" \
        -e "s/$sz/ß/g"   \
        -e "s/$AUml/Ä/g" \
        -e "s/$OUml/Ö/g" \
        -e "s/$UUml/Ü/g" \
        -e "s/$pagesNdash/\1–\2/g"`
  echo $doc1 | $(curl -T - -X PUT http://$SERVER1:$PORT/$DB1/$id 2>1 >/dev/null)
done

exit
